(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["pages/list/index"],{"20d1":function(t,e,n){},"32f9":function(t,e,n){"use strict";(function(t,r){var u=n("47a9");Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0;var a=u(n("7eb4")),s=u(n("ee10")),c=u(n("c8b7")),i={computed:{},watch:{},data:function(){return{userList:[],currentUserId:!1,mineId:!1}},onNavigationBarButtonTap:function(){t.navigateTo({url:"/pages/login/login",success:function(t){},fail:function(){},complete:function(){}})},onLoad:function(){var t=this;return(0,s.default)(a.default.mark((function e(){var n;return a.default.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,t.getUserList();case 2:return n=e.sent,console.log(n),e.next=6,t.getCloudUserList();case 6:case"end":return e.stop()}}),e)})))()},created:function(){var e=this;t.$on("handlePush",function(){var t=(0,s.default)(a.default.mark((function t(n){var r,u;return a.default.wrap((function(t){while(1)switch(t.prev=t.next){case 0:return r=n.payload,console.log("来消息了",r),u=r.fromId==e.currentUserId?1:0,t.next=5,c.default.executeSql(["create table if not exists msg('isRead' INTEGER,'fromId' CHAR(32),'toId' CHAR(32),'text' VARCHAR(255),'timestamp' INTEGER)","insert into msg values("+u+",'"+r.fromId+"','"+r.toId+"','"+r.text+"','"+r.timestamp+"')"]);case 5:return t.sent,t.next=8,e.updateMsgList();case 8:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}()),t.$on("toChat",(function(t){var n=t.currentUserId,r=t.username;e.toChat(n,r)})),t.$on("getCloudUserList",(0,s.default)(a.default.mark((function t(){return a.default.wrap((function(t){while(1)switch(t.prev=t.next){case 0:return console.log("getCloudUserList"),t.next=3,e.getCloudUserList();case 3:case"end":return t.stop()}}),t)}))))},beforeDestroy:function(){console.log("beforeDestroy"),t.$off("handlePush"),t.$off("toChat"),t.$off("getCloudUserList")},onShow:function(){var e=this;return(0,s.default)(a.default.mark((function n(){return a.default.wrap((function(n){while(1)switch(n.prev=n.next){case 0:e.mineId=t.getStorageSync("userInfo").uid,e.currentUserId=!1,e.updateMsgList();case 3:case"end":return n.stop()}}),n)})))()},onPullDownRefresh:function(){var e=this;return(0,s.default)(a.default.mark((function n(){return a.default.wrap((function(n){while(1)switch(n.prev=n.next){case 0:return n.next=2,e.getCloudUserList();case 2:t.stopPullDownRefresh();case 3:case"end":return n.stop()}}),n)})))()},methods:{updateMsgList:function(){var e=this;return(0,s.default)(a.default.mark((function n(){var r,u;return a.default.wrap((function(n){while(1)switch(n.prev=n.next){case 0:return n.next=2,c.default.selectSql("\n\t\t\t\tselect timestamp,text,fromId,count(fromId) as num\n\t\t\t\tfrom msg\n\t\t\t\tWHERE isRead = 0\n\t\t\t\tGROUP BY fromId\n\t\t\t");case 2:return r=n.sent,u=r.data,console.log(u),n.next=7,c.default.executeSql('UPDATE userList SET "num" = 0');case 7:return u.forEach(function(){var t=(0,s.default)(a.default.mark((function t(e){var n,r,u,s;return a.default.wrap((function(t){while(1)switch(t.prev=t.next){case 0:return n=e.num,r=e.fromId,u=e.text,s=e.timestamp,console.log(u,n),t.next=4,c.default.executeSql('\n\t\t\t\t\tUPDATE \n\t\t\t\t\t\t"userList"\n\t\t\t\t\tSET \n\t\t\t\t\t\t"num" = '.concat(n,',\n\t\t\t\t\t\t"text" = "').concat(u,'",\n\t\t\t\t\t\t"timestamp" = ').concat(s,'\n\t\t\t\t\tWHERE \n\t\t\t\t\t\t"_id" = "').concat(r,'"\n\t\t\t\t'));case 4:t.sent;case 5:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}()),n.next=10,e.getUserList();case 10:u.length>0&&0!=e.currentUserId&&t.vibrateLong();case 11:case"end":return n.stop()}}),n)})))()},toChat:function(e,n){this.currentUserId=e,t.navigateTo({url:"/pages/chat/chat?currentUserId="+e+"&mineId="+this.mineId+"&username="+n})},getUserList:function(){var t=this;return(0,s.default)(a.default.mark((function e(){return a.default.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.abrupt("return",new Promise(function(){var e=(0,s.default)(a.default.mark((function e(n){var r,u;return a.default.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,c.default.selectSql('select * from "userList" ORDER BY timestamp DESC');case 2:r=e.sent,u=r.data,t.userList=u,n(u);case 6:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()));case 1:case"end":return e.stop()}}),e)})))()},getCloudUserList:function(){var e=this;return(0,s.default)(a.default.mark((function n(){return a.default.wrap((function(n){while(1)switch(n.prev=n.next){case 0:return n.abrupt("return",new Promise(function(){var n=(0,s.default)(a.default.mark((function n(u){return a.default.wrap((function(n){while(1)switch(n.prev=n.next){case 0:r.callFunction({name:"uchat",data:{route:"getUser"},success:function(n){var r=n.result,i=r.code,o=r.data;if(console.log(i),!t.getStorageSync("userInfo"))return u(o),t.navigateTo({url:"/pages/login/login"}),!1;o.forEach(function(){var t=(0,s.default)(a.default.mark((function t(n){var r,u;return a.default.wrap((function(t){while(1)switch(t.prev=t.next){case 0:return t.next=2,c.default.selectSql('\n\t\t\t\t\t\t\t\tselect * from userList WHERE "_id" = "'.concat(n._id,'"\n\t\t\t\t\t\t\t'));case 2:if(r=t.sent,u=r.data,u.length){t.next=11;break}return n.text="暂无消息",n.timestamp=Date.now(),n.num=0,e.userList.push(n),t.next=11,c.default.executeSql(["create table if not exists userList('_id' CHAR(32),'username' VARCHAR(255),'text' VARCHAR(255),'timestamp' INTEGER,'num' INTEGER)","insert into userList values('"+n._id+"','"+n.username+"','"+n.text+"','"+n.timestamp+"','"+n.num+"')"]);case 11:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}()),u(o)},fail:function(e){t.showModal({title:"err",content:JSON.stringify(e),showCancel:!1}),u()}});case 1:case"end":return n.stop()}}),n)})));return function(t){return n.apply(this,arguments)}}()));case 1:case"end":return n.stop()}}),n)})))()}}};e.default=i}).call(this,n("df3c")["default"],n("861b")["default"])},"35dd":function(t,e,n){"use strict";n.d(e,"b",(function(){return u})),n.d(e,"c",(function(){return a})),n.d(e,"a",(function(){return r}));var r={uniNoticeBar:function(){return n.e("uni_modules/uni-notice-bar/components/uni-notice-bar/uni-notice-bar").then(n.bind(null,"9125"))},user:function(){return n.e("components/user/user").then(n.bind(null,"23ed"))}},u=function(){var t=this.$createElement;this._self._c},a=[]},4165:function(t,e,n){"use strict";(function(t,e){var r=n("47a9");n("8ed8"),n("c891"),n("861b");r(n("3240"));var u=r(n("530a"));t.__webpack_require_UNI_MP_PLUGIN__=n,e(u.default)}).call(this,n("3223")["default"],n("df3c")["createPage"])},"530a":function(t,e,n){"use strict";n.r(e);var r=n("35dd"),u=n("e027");for(var a in u)["default"].indexOf(a)<0&&function(t){n.d(e,t,(function(){return u[t]}))}(a);n("b889"),n("e903");var s=n("828b"),c=Object(s["a"])(u["default"],r["b"],r["c"],!1,null,"1b14aa5e",null,!1,r["a"],void 0);e["default"]=c.exports},b889:function(t,e,n){"use strict";var r=n("20d1"),u=n.n(r);u.a},cf06:function(t,e,n){},e027:function(t,e,n){"use strict";n.r(e);var r=n("32f9"),u=n.n(r);for(var a in r)["default"].indexOf(a)<0&&function(t){n.d(e,t,(function(){return r[t]}))}(a);e["default"]=u.a},e903:function(t,e,n){"use strict";var r=n("cf06"),u=n.n(r);u.a}},[["4165","common/runtime","common/vendor"]]]);