(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["pages/chat/chat"],{"6ed2":function(t,e,n){"use strict";var r=n("e0c0"),a=n.n(r);a.a},"72ac":function(t,e,n){"use strict";n.d(e,"b",(function(){return a})),n.d(e,"c",(function(){return s})),n.d(e,"a",(function(){return r}));var r={msg:function(){return Promise.all([n.e("common/vendor"),n.e("components/msg/msg")]).then(n.bind(null,"2a90"))}},a=function(){var t=this.$createElement,e=(this._self._c,this.msgList.length);this.$mp.data=Object.assign({},{$root:{g0:e}})},s=[]},"792a":function(t,e,n){},"855c":function(t,n,r){"use strict";(function(t,a){var s=r("47a9");Object.defineProperty(n,"__esModule",{value:!0}),n.default=void 0;var c=s(r("7eb4")),i=s(r("34cf")),o=s(r("ee10")),u=s(r("c8b7")),d=weex.requireModule("dom")||{},f={computed:{chatListHeight:function(){return this.wHeight-this.keyboardHeight-66-(this.textareaHeight-36)}},watch:{msgList:function(t,e){}},data:function(){return{msgList:[],currentUserId:!1,mineId:!1,keyboardHeight:0,text:"",wHeight:"",textareaHeight:26}},created:function(){var e=this;this.wHeight=t.getSystemInfoSync().windowHeight,t.onKeyboardHeightChange((function(t){var n=t.height;console.log(n),e.keyboardHeight=n}))},onLoad:function(e){var n=this;return(0,o.default)(c.default.mark((function r(){var a,s,i,d;return c.default.wrap((function(r){while(1)switch(r.prev=r.next){case 0:return a=e.currentUserId,s=e.mineId,i=e.username,n.currentUserId=a,n.mineId=s,i&&t.setNavigationBarTitle({title:i}),r.next=6,u.default.executeSql('UPDATE msg SET "isRead" = 1 WHERE "fromId" = "'.concat(a,'"'));case 6:return d=r.sent,console.log(d),console.log({currentUserId:a,mineId:s}),r.next=11,n.getUnReadNum();case 11:n.getNewMsg(),t.$on("handlePush",function(){var t=(0,o.default)(c.default.mark((function t(e){var r;return c.default.wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(r=e.payload,r.fromId!=n.currentUserId){t.next=9;break}return n.msgList.push({text:r.text,toId:r.toId,fromId:r.fromId,timestamp:r.timestamp,isRead:1}),n.showLast(),t.next=6,u.default.executeSql('\n\t\t\t\t\tUPDATE \n\t\t\t\t\t\t"userList"\n\t\t\t\t\tSET \n\t\t\t\t\t\t"num" = 0,\n\t\t\t\t\t\t"text" = "'.concat(r.text,'",\n\t\t\t\t\t\t"timestamp" = ').concat(r.timestamp,'\n\t\t\t\t\tWHERE \n\t\t\t\t\t\t"_id" = "').concat(r.fromId,'"\n\t\t\t\t'));case 6:t.sent,t.next=11;break;case 9:return t.next=11,n.getUnReadNum();case 11:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}());case 13:case"end":return r.stop()}}),r)})))()},methods:{getNewMsg:function(){var t=this;return(0,o.default)(c.default.mark((function e(){var n,r;return c.default.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,u.default.selectSql('select * from msg WHERE \n\t\t\t\t("fromId" = "'.concat(t.currentUserId,'" AND "toId" = "').concat(t.mineId,'") \n\t\t\t\tOR \n\t\t\t\t("toId" = "').concat(t.currentUserId,'" AND "fromId" = "').concat(t.mineId,'") \n\t\t\t\tORDER BY "timestamp" DESC\n\t\t\t'));case 2:n=e.sent,r=n.data,console.log("getNewMsg",r,t.mineId,t.currentUserId),t.msgList=r.reverse(),t.showLast(!1);case 7:case"end":return e.stop()}}),e)})))()},touchList:function(){t.hideKeyboard()},input:function(){"ios"==t.getSystemInfoSync().platform&&this.text.indexOf("\n")>=0&&(console.log("中有\n"),this.text=this.text.substring(0,this.text.length-2),this.text&&this.send())},send:function(){var n=this;return(0,o.default)(c.default.mark((function r(){var s,i;return c.default.wrap((function(r){while(1)switch(r.prev=r.next){case 0:if(n.text){r.next=2;break}return r.abrupt("return",!1);case 2:return s=n.text,a.callFunction({name:"uchat",data:{route:"sendMsg",text:s,userInfo:t.getStorageSync("userInfo"),toId:n.currentUserId},success:function(){var r=(0,o.default)(c.default.mark((function r(a){var i,o,d;return c.default.wrap((function(r){while(1)switch(r.prev=r.next){case 0:if(i=a.result,o=i.code,d=i.data,console.log(o),t.getStorageSync("userInfo")){r.next=5;break}return t.navigateTo({url:"/pages/login/login"}),r.abrupt("return",!1);case 5:if(20001!=d.code){r.next=8;break}return t.showModal({title:"错误",content:e.result.msg+"或对方没在云打包或自定义的基座运行",showCancel:!1,confirmText:"关闭"}),r.abrupt("return",!1);case 8:return r.next=10,u.default.executeSql('\n\t\t\t\t\t\tUPDATE \n\t\t\t\t\t\t\t"userList"\n\t\t\t\t\t\tSET \n\t\t\t\t\t\t\t"num" = 0,\n\t\t\t\t\t\t\t"text" = "'.concat(s,'",\n\t\t\t\t\t\t\t"timestamp" = ').concat(Date.now(),'\n\t\t\t\t\t\tWHERE \n\t\t\t\t\t\t\t"_id" = "').concat(n.currentUserId,'"\n\t\t\t\t\t'));case 10:r.sent;case 11:case"end":return r.stop()}}),r)})));return function(t){return r.apply(this,arguments)}}(),fail:function(e){t.showModal({title:"err",content:JSON.stringify(e),showCancel:!1})}}),n.msgList.push({text:n.text,toId:n.currentUserId,fromId:n.mineId,timestamp:Date.now()}),r.next=7,u.default.executeSql(["create table if not exists msg('isRead' INTEGER,'fromId' CHAR(32),'toId' CHAR(32),'text' VARCHAR(255),'timestamp' INTEGER)","insert into msg values(1,'"+n.mineId+"','"+n.currentUserId+"','"+n.text+"','"+Date.now()+"')"]);case 7:i=r.sent,console.log(i),n.$nextTick((function(){n.text="",n.textareaHeight=26})),n.showLast();case 11:case"end":return r.stop()}}),r)})))()},getUnReadNum:function(){return(0,o.default)(c.default.mark((function t(){var e,n,r,a;return c.default.wrap((function(t){while(1)switch(t.prev=t.next){case 0:return t.next=2,u.default.selectSql("\n\t\t\t\tselect  count(*) as num\n\t\t\t\tfrom msg\n\t\t\t\tWHERE isRead = 0\n\t\t\t");case 2:if(e=t.sent,n=(0,i.default)(e.data,1),r=n[0],r){t.next=7;break}return t.abrupt("return",!1);case 7:a=r.num,console.log(a),plus.webview.currentWebview().setTitleNViewButtonStyle(0,{text:0!==a?a:""});case 10:case"end":return t.stop()}}),t)})))()},showLast:function(){var t=this,e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this.msgList.length&&this.$nextTick((function(){setTimeout((function(){var n=t.$refs.msg[t.msgList.length-1];d.scrollToElement(n,{animated:e})}),100)}))},linechange:function(t){var e=t.detail,n=e.height,r=e.lineCount;1===r&&(this.textareaHeight=26),1!==r&&n<=100&&(console.log("来来来1"),this.textareaHeight=n)},focus:function(t){},stop:function(t){t.stopPropagation()}},beforeDestroy:function(){},onNavigationBarButtonTap:function(){t.navigateBack()}};n.default=f}).call(this,r("df3c")["default"],r("861b")["default"])},"87e1":function(t,e,n){"use strict";n.r(e);var r=n("72ac"),a=n("cd86");for(var s in a)["default"].indexOf(s)<0&&function(t){n.d(e,t,(function(){return a[t]}))}(s);n("6ed2"),n("881b");var c=n("828b"),i=Object(c["a"])(a["default"],r["b"],r["c"],!1,null,null,null,!1,r["a"],void 0);e["default"]=i.exports},"881b":function(t,e,n){"use strict";var r=n("792a"),a=n.n(r);a.a},cd86:function(t,e,n){"use strict";n.r(e);var r=n("855c"),a=n.n(r);for(var s in r)["default"].indexOf(s)<0&&function(t){n.d(e,t,(function(){return r[t]}))}(s);e["default"]=a.a},da76:function(t,e,n){"use strict";(function(t,e){var r=n("47a9");n("8ed8"),n("c891"),n("861b");r(n("3240"));var a=r(n("87e1"));t.__webpack_require_UNI_MP_PLUGIN__=n,e(a.default)}).call(this,n("3223")["default"],n("df3c")["createPage"])},e0c0:function(t,e,n){}},[["da76","common/runtime","common/vendor"]]]);